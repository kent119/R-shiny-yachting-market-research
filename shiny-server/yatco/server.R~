library(shiny)
library(ggvis)
#source("/srv/shiny-server/boatinternational/cleaning.R")
load("/srv/shiny-server/boatinternational/data_boatinternational.Rda")

# Define server logic required to draw a histogram
shinyServer(function(input, output, session) {
  
  ############################################
  # filter the yachts, return a dataframe
  yachts_filted <- reactive({
    # Due to dplyr issue #318, we need temp variables for input values
    selected_loa_min <- input$slider_loa[1]
    selected_loa_max <- input$slider_loa[2]
    selected_price_min <- input$slider_price[1] * 1e6
    selected_price_max <- input$slider_price[2] * 1e6
    selected_year_min <- input$slider_year[1]
    selected_year_max <- input$slider_year[2]
    # Apply filters
    selected_yachts <- yachts %>%
      filter(
        loa >= selected_loa_min,
        loa <= selected_loa_max,
        price >= selected_price_min,
        price <= selected_price_max,
        year <= selected_year_max,
        year >= selected_year_min
      ) %>%
      arrange(loa)
     
    selected_yachts <- as.data.frame(selected_yachts)
    
    #
    #print("debug_filter_sucess")
    selected_yachts
  })

  # Function for generating tooltip text
  yacht_tooltip <- function(x) {
    if (is.null(x)) text1 <- "x is null <br>" else text1 <- "x is not null <br>"#return(NULL)
    if (is.null(x$id)) text2<- toString(colnames(x)) else text2<- "x id is not null <br>"#return(NULL)

    # Pick out the yacht with this ID
    all_yachts <- isolate(yachts_filted())
    the_yacht <- all_yachts[all_yachts$price == x$price, ]
    the_yacht <- the_yacht[the_yacht$year == x$year, ]
    the_yacht <- the_yacht[the_yacht$loa == x$loa, ]

    paste0("<b>", the_yacht$name, "</b><br>",
      #toString(head(the_yacht)), "<br>",
      #toString(summary(the_yacht)), "<br>",
      the_yacht$text_loa, "<br>",
      the_yacht$text_price, "<br>",
      the_yacht$builder, " - ", the_yacht$text_year
    )
  }

  yacht_price <- reactive({
    # Lables for axes
    xvar_name <- "LOA (m)"
    yvar_name <- "Prince (USD)"

    yachts_filted %>%
      #ggvis(x = xvar, y = yvar) %>%
      ggvis(~loa, ~price) %>%
      layer_points(size := 50, size.hover := 200,
        fillOpacity := 0.2, fillOpacity.hover := 0.5,
        stroke = ~year) %>%
      add_tooltip(yacht_tooltip, "hover") %>%
      #add_tooltip(
      #  function(x){
          #if (is.null(x)) text1 <- "x is null"
          #if (is.null(x$name)) text2 <- "x$name is null"
          #all_yachts <- isolate(yachts_filted())
          #the_yacht <- all_yachts[all_yachts$name == x$name, ]
       #   paste0(#text1, "<br>", text2, "<br>",
       #          "<b>", the_yacht$name, "</b><br>",
       #          the_yacht$text_loa, "<br>",
       #          the_yacht$text_price, "<br>",
       #          the_yacht$builder, " - ", the_yacht$text_year
       #         ) 
       #   },
       # "hover") %>%
      add_axis("x", title = xvar_name) %>%
      add_axis("y", title = yvar_name, title_offset = 100) %>%
      #add_legend("stroke", title = "Year of Build", values = factor(~year) ) %>%
      #scale_numeric("fill", domain = c(0,100),
        #range = c("red", "green")) %>%
      #scale_numeric("stroke", domain = c(0,100)) %>%
      set_options(width = 1000, height = 800)
  })
  yacht_price %>% bind_shiny("yacht_price")

})
